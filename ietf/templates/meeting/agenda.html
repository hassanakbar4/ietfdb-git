{% extends "base.html" %}
{# Copyright The IETF Trust 2015, All Rights Reserved #}
{% load origin %}
{% load static %}
{% load ietf_filters %}
{% load textfilters %}
{% load htmlfilters %}

{% block title %}
  IETF {{ schedule.meeting.number }} meeting agenda
  {% if "-utc" in request.path %}
    (UTC)
  {% endif %}
{% endblock %}

{% block morecss %}
  iframe#weekview { height: 600px; width: 100%; }
  tr:not(:first-child) th.gap {
  height: 3em !important;
  background-color: inherit !important;
  border: none !important;
  }
  tr:first-child th.gap {
  height: 0 !important;
  background-color: inherit !important;
  border: none !important;
  }
{% endblock %}

{% block bodyAttrs %}data-spy="scroll" data-target="#affix"{% endblock %}

{% block content %}
  {% origin %}

  <div class="row">
    <div class="col-md-12">
      {% if "-utc" in request.path %}
        {% include "meeting/meeting_heading.html" with meeting=schedule.meeting updated=updated selected="agenda-utc" title_extra="(UTC)" %}
      {% else %}
        {% include "meeting/meeting_heading.html" with meeting=schedule.meeting updated=updated selected="agenda"     title_extra="" %}
      {% endif %}

    </div>
  </div>
  <div class="row">
     <div class="col-md-10">
      {# cache this part -- it takes 3-6 seconds to generate #}
      {% load cache %}
      {% cache cache_time ietf_meeting_agenda_utc schedule.meeting.number request.path %}
        <h1>Agenda</h1>
        <div id="timezone">Timezone:
	   <select id="timezone_select"></select>
	   <button id="meeting-timezone" onclick="use_timezone(0)">Meeting Timezone</button>
	   <button id="local-timezone" onclick="use_timezone(1)">Local Timezone</button>
	   <button id="utc-timezone" onclick="use_timezone(2)">UTC</button>
	   <span id="current-time"></span>
	</div>
      {% if is_current_meeting %}
	<p class="alert alert-info">
	  <b>Note:</b> IETF agendas are subject to change, up to and during a meeting.
	</p>
      {% endif %}

  {% if schedule.meeting.agenda_info_note %}
    <p class="alert alert-info">
      {{ schedule.meeting.agenda_info_note|removetags:"h1"|safe }}
    </p>
  {% endif %}


  {% include "meeting/agenda_filter.html" with group_parents=group_parents non_area_filters=True customize_button_text="Customize the agenda view..." only %}

        <h2>Download as .ics</h2>
        <p class="buttonlist">
          {% for p in group_parents %}
            <a class="btn btn-default" href="{% url "ietf.meeting.views.agenda_ical" num=schedule.meeting.number %}?show={{p.acronym|upper}}">{{p.acronym|upper}}</a>
          {% endfor %}
          <a class="btn btn-default" href="{% url "ietf.meeting.views.agenda_ical" num=schedule.meeting.number %}?showtypes=plenary,other">Non-area events</a>
          <a id="ical-link" class="hidden btn btn-primary" href="{% url "ietf.meeting.views.agenda_ical" num=schedule.meeting.number %}">Customized schedule</a>
        </p>


        <h2>
          Schedule
          {% if schedule.meeting.agenda_warning_note %}
            <span class="label label-danger">{{ schedule.meeting.agenda_warning_note|removetags:"h1"|safe }}</span>
          {% endif %}
        </h2>

        <iframe seamless class="hidden" id="weekview"></iframe>

        <table class="table table-condensed table-striped">
          {% for item in filtered_assignments %}

            {% ifchanged item.timeslot.time|date:"Y-m-d" %}
              <tr><th class="gap" colspan="5"></th></tr>
              <tr class="warning">
                <th colspan="5">
		   {# The anchor here needs to be in a div, not in the th, in order for the anchor-target margin hack to work #}
		   <div class="anchor-target" id="{{item.timeslot.time|slugify}}"></div>
	            {{ item.timeslot.time|date:"l, F j, Y" }}
	        </th>
              </tr>
            {% endifchanged %}

            {% if item.timeslot.type_id == 'regular' %}
              {% ifchanged %}
                <tr class="info"
                    slot_start="{{item.start_time}}"
                    slot_end="{{item.end_time}}">
                  <th class="text-nowrap text-right">
                    <span class="hidden-xs">
                       {% include "meeting/timeslot_start_end.html" %}
                    </span>
	          </th>
	          <th colspan="4">
                    <span class="hidden-sm hidden-md hidden-lg">
                       {% include "meeting/timeslot_start_end.html" %}
                    </span>
	            {{ item.timeslot.time|date:"l"}}
	            {{item.timeslot.name|capfirst_allcaps}}
	          </th>
                </tr>
              {% endifchanged %}
            {% endif %}

            {% if item.timeslot.type.slug == 'break' or item.timeslot.type.slug == 'reg' or item.timeslot.type.slug == 'other' %}
                <tr id="row-{{ item.slug }}"
                    slot_start="{{item.start_time}}"
                    slot_end="{{item.end_time}}"
                    data-item-group="{% if item.session.historic_group %}{{ item.session.historic_group.acronym }}{% endif %}"
                    data-item-area="{% if item.session.historic_group and item.session.historic_group.historic_parent %}{{ item.session.historic_group.historic_parent.acronym }}{% endif %}"
                    data-timeslot-type="{{item.timeslot.type.slug}}">
	          <td class="text-nowrap text-right">
                    <span class="hidden-xs">
                       {% include "meeting/timeslot_start_end.html" %}
                    </span>
	          </td>
                  <td colspan="3">
                    <span class="hidden-sm hidden-md hidden-lg">
                       {% include "meeting/timeslot_start_end.html" %}
                    </span>
                    {% if item.timeslot.show_location and item.timeslot.get_html_location %}
		      {% if schedule.meeting.number|add:"0" < 96 %}
                      <a href="https://tools.ietf.org/agenda/{{schedule.meeting.number}}/venue/?room={{ item.timeslot.get_html_location|xslugify }}">{{item.timeslot.get_html_location}}</a>
                      {% elif item.timeslot.location.floorplan %}
		      <a href="{% url 'ietf.meeting.views.floor_plan' num=schedule.meeting.number %}?room={{ item.timeslot.get_html_location|xslugify }}">{{item.timeslot.get_html_location}}</a>
		      {% else %}
                      {{item.timeslot.get_html_location}}
		      {% endif %}
		      {% with item.timeslot.location.floorplan as floor %}
		      {% if item.timeslot.location.floorplan %}
                      <span class="hidden-xs">
			<a href="{% url 'ietf.meeting.views.floor_plan' num=schedule.meeting.number %}#{{floor.name|xslugify}}"
			  class="pull-right" title="{{floor.name}}"><span class="label label-blank label-wide">{{floor.short}}</span></a>
                      </span>
		      {% endif %}
		      {% endwith %}
	            {% endif %}
	          </td>
                  <td>
		    {% if item.session.agenda %}
		      <a href="{{ item.session.agenda.get_href }}">
			{{item.timeslot.name}}
		      </a>
		    {% else %}
		      {{item.timeslot.name}}
		    {% endif %}

                    {% if item.session.current_status == 'canceled' %}
		      <span class="label label-danger pull-right">CANCELLED</span>
                    {% else %}
                      <div class="pull-right padded-left">
                        {% if item.timeslot.type.slug == 'other' %}
                          {% if item.session.agenda or item.session.remote_instructions or item.session.agenda_note %}
                            {% include "meeting/session_buttons_include.html" with show_agenda=True session=item.session meeting=schedule.meeting %}
                          {% else %}
                            {% for slide in item.session.slides %}
                              <a href="{{slide.get_href}}">{{ slide.title|clean_whitespace }}</a>
                              <br>
                            {% endfor %}
                          {% endif %}
                        {% endif %}
                      </div>
		    {% endif %}
		  </td>
                </tr>
            {% endif %}

            {% if item.timeslot.type_id == 'regular' or item.timeslot.type.slug == 'plenary' %}
              {% if item.session.historic_group %}
                <tr id="row-{{item.slug}}"
                    slot_start="{{item.start_time}}"
                    slot_end="{{item.end_time}}"
                    data-item-group="{{ item.session.historic_group.acronym }}"
                    data-item-area="{% if item.session.historic_group.historic_parent %}{{ item.session.historic_group.historic_parent.acronym }}{% endif  %}"
                    data-timeslot-type="{{item.timeslot.type.slug}}"
                    data-ske="row-{{ item.slug }}" {% if item.timeslot.type.slug == 'plenary' %}class="{{item.timeslot.type.slug}}danger"{% endif %}>
		  {% if item.timeslot.type.slug == 'plenary' %}
	            <th class="text-nowrap text-right">
                      <span class="hidden-xs">
                         {% include "meeting/timeslot_start_end.html" %}
                      </span>
		    </th>
		    <td colspan="3">
                      <span class="hidden-sm hidden-md hidden-lg">
                         {% include "meeting/timeslot_start_end.html" %}
                      </span>
		      {% if item.timeslot.show_location and item.timeslot.get_html_location %}
			{% if schedule.meeting.number|add:"0" < 96 %}
			<a href="https://tools.ietf.org/agenda/{{schedule.meeting.number}}/venue/?room={{ item.timeslot.get_html_location|xslugify }}">{{item.timeslot.get_html_location}}</a>
                        {% elif item.timeslot.location.floorplan %}
			<a href="{% url 'ietf.meeting.views.floor_plan' num=schedule.meeting.number %}?room={{ item.timeslot.get_html_location|xslugify }}">{{item.timeslot.get_html_location}}</a>
			{% else %}
                        {{item.timeslot.get_html_location}}
			{% endif %}
		      {% endif %}
		    </td>

		  {% else %}
		    <td>
		      {% with item.timeslot.location.floorplan as floor %}
		      {% if item.timeslot.location.floorplan %}
                      <span class="hidden-xs">
			<a href="{% url 'ietf.meeting.views.floor_plan' num=schedule.meeting.number %}#{{floor.name|xslugify}}"
			  class="pull-right" title="{{floor.name}}"><span class="label label-blank">{{floor.short}}</span></a>
                      </span>
		      {% endif %}
		      {% endwith %}
		    </td>
                    <td>
                      {% if item.timeslot.show_location and item.timeslot.get_html_location %}
			{% if schedule.meeting.number|add:"0" < 96 %}
			<a href="https://tools.ietf.org/agenda/{{schedule.meeting.number}}/venue/?room={{ item.timeslot.get_html_location|xslugify }}">{{item.timeslot.get_html_location}}</a>
                        {% elif item.timeslot.location.floorplan %}
			<a href="{% url 'ietf.meeting.views.floor_plan' num=schedule.meeting.number %}?room={{ item.timeslot.get_html_location|xslugify }}">{{item.timeslot.get_html_location}}</a>
                        {% else %}
                        {{item.timeslot.get_html_location}}
			{% endif %}
                      {% endif %}
                    </td>

		      <td><span class="hidden-xs">{{item.session.historic_group.historic_parent.acronym}}</span></td>

                    <td>
                      {% if item.session.historic_group %}
                        <a href="{% url 'ietf.group.views.group_about' acronym=item.session.historic_group.acronym %}">{{item.session.historic_group.acronym}}</a>
                      {% else %}
                        {{item.session.historic_group.acronym}}
                      {% endif %}
                    </td>
                  {% endif %}

                  <td>
                    {% if item.session.agenda %}
		      <a href="{{ item.session.agenda.get_href }}">
                    {% endif %}
                    {% if item.timeslot.type.slug == 'plenary' %}
                      {{item.timeslot.name}}
                    {% else %}
                      {{item.session.historic_group.name}}
                    {% endif %}
                    {% if item.session.agenda %}
                      </a>
                    {% endif %}

                    {% if item.session.current_status == 'canceled' %}
                      <span class="label label-danger pull-right">CANCELLED</span>
                    {% else %}
                      <div class="pull-right padded-left">
                         {% include "meeting/session_buttons_include.html" with show_agenda=True session=item.session meeting=schedule.meeting %}
                      </div>
                    {% endif %}

                    {% if item.session.historic_group.state_id == "bof" %}
                      <span class="label label-success pull-right">BOF</span>
                    {% endif %}

                    {% if item.session.current_status == 'resched' %}
                      <span class="label label-danger pull-right">
                        RESCHEDULED
                        {% if item.session.rescheduled_to %}
                          TO
                          <span class="timetooltip reschedtimetooltip"><span class="time" start_time="{{item.session.rescheduled_to.utc_start_time|date:"U"}}" end_time="{{item.session.rescheduled_to.utc_end_time|date:"U"}}" {% if item.timeslot.time|date:"l" != item.session.rescheduled_to.time|date:"l" %} weekday="1"{% endif %}>
		          {% if "-utc" in request.path %}
                            {{ item.session.rescheduled_to.utc_start_time|date:"l G:i"|upper }}-{{ item.session.rescheduled_to.utc_end_time|date:"G:i" }}
		          {% else %}
                            {{ item.session.rescheduled_to.time|date:"l G:i"|upper }}-{{ item.session.rescheduled_to.end_time|date:"G:i" }}
		          {% endif %}
			  </span></span>
                        {% endif %}
                      </span>
                    {% endif %}

                    {% if item.session.agenda_note|first_url|conference_url %}
                      <br><a href={{item.session.agenda_note|first_url}}>{{item.session.agenda_note|slice:":23"}}</a>
                    {% elif item.session.agenda_note %}
                      <br><span class="text-danger">{{item.session.agenda_note}}</span>
                    {% endif %}
		  </td>
		</tr>
              {% endif %}
            {% endif %}
          {% endfor %}
        </table>

    </div>
    <div class="col-md-2 hidden-print bs-docs-sidebar" id="affix">
      <ul class="nav nav-pills nav-stacked small" data-spy="affix">
        <li><a href="#now">Now</a></li>
        {% for item in filtered_assignments %}
          {% ifchanged item.timeslot.time|date:"Y-m-d" %}
            <li><a href="#{{item.timeslot.time|slugify}}">{{ item.timeslot.time|date:"l, F j, Y" }}</a></li>
          {% endifchanged %}
        {% endfor %}
      </ul>
    </div>
  </div>

  {% endcache %}
{% endblock %}

{% block js %}

  <script src="{% static 'ietf/js/agenda/agenda_filter.js' %}"></script>
  <script>
   // Update the agenda display with specified filters
   function update_agenda_display(filter_params) {
       var agenda_rows=$('[id^="row-"]')

       if (!agenda_filter.filtering_is_enabled(filter_params)) {
           // When filtering is not enabled, show all sessions
           agenda_rows.show();
           return;
       }

       // if groups were selected for filtering, hide all rows by default
       agenda_rows.hide();

       // loop through the has items and change the UI element and row visibilities accordingly
       $.each(filter_params['show_groups'], function (i, v) {
           // this is a regular item by wg: when present, show these rows
           agenda_rows.filter('[data-item-group="'+ v +'"]').show();
           agenda_rows.filter('[data-item-area="'+ v +'"]').show();
       });
       $.each(filter_params['show_types'], function (i, v) {
           // this is a regular item by type: when present, show these rows
           agenda_rows.filter('[data-timeslot-type*="' + v + '"]').show();
       });
       $.each(filter_params['hide_groups'], function (i, v) {
           // this is a "negative" item by wg: when present, hide these rows
           agenda_rows.filter('[data-item-group="'+ v +'"]').hide();
           agenda_rows.filter('[data-item-area="'+ v +'"]').hide();
       });
       $.each(filter_params['hide_types'], function (i, v) {
           // this is a "negative" item by type: when present, hide these rows
           agenda_rows.filter('[data-timeslot-type*="' + v + '"]').hide();
       });
   }

   function update_ical_links(filter_params) {
       var ical_link = $("#ical-link");
       if (agenda_filter.filtering_is_enabled(filter_params)) {
           // Replace the query string in the ical link
           var orig_link_href = ical_link.attr("href").split("?")[0];
           ical_link.attr("href", orig_link_href+window.location.search);
           ical_link.removeClass("hidden");
       } else {
           ical_link.addClass("hidden");
       }
   }

      function update_weekview(filter_params) {
          var weekview = $("#weekview");

          if (!agenda_filter.filtering_is_enabled(filter_params)) {
              weekview.addClass("hidden");
              return;
          }

          // Filtering is enabled
          weekview.removeClass("hidden");

          var wv_iframe = document.getElementById('weekview');
          var wv_window = wv_iframe.contentWindow;
          var new_url = 'week-view.html' + window.location.search;
          if (wv_iframe.src && wv_window.history && wv_window.history.replaceState) {
              wv_window.history.replaceState({}, '', new_url);
              wv_window.draw_calendar()
          } else {
              // ho history.replaceState, page reload required
              wv_iframe.src = new_url;
          }
      }

   function update_view(filter_params) {
       update_agenda_display(filter_params);
       update_weekview(filter_params)
       update_ical_links(filter_params)
   }

   agenda_filter.set_update_callback(update_view);
   agenda_filter.enable();

   $(".modal").on("show.bs.modal", function () {
       var i = $(this).find(".frame");
       if ($(i).data("src")) {
           $.get($(i).data("src"), function (data, status, xhr) {
               var t = xhr.getResponseHeader("content-type");
               if (t.indexOf("text/plain") > -1) {
                   data = "<pre class='agenda'>" + data + "</pre>";
               } else if (t.indexOf("text/markdown") > -1) {
                   data = "<pre class='agenda'>" + data + "</pre>";
               } else if(t.indexOf("text/html") > -1) {
                   // nothing to do here
               } else {
                   data = "<p>Unknown type: " + xhr.getResponseHeader("content-type") + "</p>";
               }
               $(i).html(data);
           });
       }
       var j = $(this).find(".frame2");
       if ($(j).data("src")) {
           $.get($(j).data("src"), function (data, status, xhr) {
               var t = xhr.getResponseHeader("content-type");
               if (t.indexOf("text/plain") > -1) {
                   data = "<pre class='agenda'>" + data + "</pre>";
               } else if (t.indexOf("text/markdown") > -1) {
                   data = "<pre class='agenda'>" + data + "</pre>";
               } else if(t.indexOf("text/html") > -1) {
                   // nothing to do here
               } else {
                   data = "<p>Unknown type: " + xhr.getResponseHeader("content-type") + "</p>";
               }
               $(j).html(data);
           });
       }
   });
   </script>
   <script src="{% static 'moment/moment.min.js' %}"></script>
   <script src="{% static 'moment/moment-timezone-with-data-10-year-range.min.js' %}"></script>
   <script>

   // Initialize moments
   function initialize_moments() {
     var times=$('span.time')
     $.each(times, function(i, item) {
       item.start_time = moment.unix(this.getAttribute("start_time")).utc();
       item.end_time = moment.unix(this.getAttribute("end_time")).utc();
       if (this.hasAttribute("weekday")) {
         item.format=2;
       } else {
         item.format=1;
       }
     });
     var times=$('[slot_start]')
     $.each(times, function(i, item) {
       item.slot_start = moment.unix(this.getAttribute("slot_start")).utc();
       item.slot_end = moment.unix(this.getAttribute("slot_end")).utc();
     });
   }
   
   // Initialize timezone system
   function timezone_init(current) {
     var tz_names = moment.tz.names();
     var select = $('#timezone_select');

     $.each(tz_names, function(i, item) {
       if (current == item) {
         select.append($('<option/>', {
           selected: "selected", html: item, value: item }));
       } else {
         select.append($('<option/>', {
           html: item, value: item }));
       }
     });
     initialize_moments();
     select.change(function () {
       update_times(this.value);
     });
     update_times(current);
     add_tooltips();
   }

   // Select which timezone is used, 0 = meeting, 1 = browser local, 2 = UTC
   function use_timezone (val) {
     switch (val) {
     case 0:
       tz = meeting_timezone;
       break;
     case 1:
       tz = local_timezone;
       break;       
     default:
       tz = 'UTC';
       break;
     }
     $('#timezone_select').val(tz);
     update_times(tz);
   }

   // Format time for item for timezone. If short is true, then use short format
   function format_time(t, tz, fmt) {
     var out;

     switch (fmt) {
     case 0:
       out = t.tz(tz).format('dddd, ') + '<span class="hidden-xs">' +
	   t.tz(tz).format('MMMM Do YYYY, ') + '</span>' +
	   t.tz(tz).format('HH:mm') + '<span class="hidden-xs">' +
	   t.tz(tz).format(' Z z') + '</span>';
       break;
     case 1:
       out = t.tz(tz).format("HH:mm");
       if (+t.tz(tz).date() < +t.tz(meeting_timezone).date()) {
         out = out + " (-1)";
       } else if (+t.tz(tz).date() > +t.tz(meeting_timezone).date()) {
         out = out + " (+1)";
       }
       break;
     case 2:
       out = t.tz(meeting_timezone).format("dddd, ").toUpperCase() +
         t.tz(tz).format("HH:mm");
       if (+t.tz(tz).date() < +t.tz(meeting_timezone).date()) {
         out = out + " (-1)";
       } else if (+t.tz(tz).date() > +t.tz(meeting_timezone).date()) {
         out = out + " (+1)";
       }
       break;
     }
     return out;
   }


   // Format tooltip notice
   function format_tooltip_notice(start, end) {
     var notice = "";

     if (end.isBefore()) {
       notice = "Event ended " + end.fromNow();
     } else if (start.isAfter()) {
       notice = "Event will start " + start.fromNow();
     } else {
       notice = "Event started " + start.fromNow() + " and will end " +
         end.fromNow();
     }
     return '<span class="tooltipnotice">' + notice + '</span>';
   }

   // Format tooltip table
   function format_tooltip_table(start, end) {
     return '<table><tr><th>Timezone</th><th>Start</th><th>End</th></tr>' +
       '<tr><td class="timehead">Meeting timezone:</td><td>' + 
       format_time(start, meeting_timezone, 0) + '</td><td>' +
       format_time(end, meeting_timezone, 0) + '</td></tr>' +
       '<tr><td class="timehead">Local timezone:</td><td>' + 
       format_time(start, local_timezone, 0) + '</td><td>' +
       format_time(end, local_timezone, 0) + '</td></tr>' +
       '<tr><td class="timehead">Selected Timezone:</td><td>' + 
       format_time(start, current_timezone, 0) + '</td><td>' +
       format_time(end, current_timezone, 0) + '</td></tr>' +
       '<tr><td class="timehead">UTC:</td><td>' + 
       format_time(start, 'UTC', 0) + '</td><td>' +
       format_time(end, 'UTC', 0) + '</td></tr>' +
       '</table>' +
       format_tooltip_notice(start, end);
   }
   
   // Format tooltip for item
   function format_tooltip(start, end) {
     return '<span class="timetooltiptext">' +
       format_tooltip_table(start, end) +
       '</span>';
   }

   // Add tooltips
   function add_tooltips() {
     $('span.time').each(function () {
       var tooltip = $(format_tooltip(this.start_time, this.end_time));
       tooltip[0].start_time = this.start_time;
       tooltip[0].end_time = this.end_time;
       tooltip[0].ustart_time = moment(this.start_time).add(-2, 'hours');
       tooltip[0].uend_time = moment(this.end_time).add(2, 'hours');
       $(this).parent().append(tooltip);
     });
   }

   // Update times on the agenda based on the selected timezone
   function update_times(newtz) {
     current_timezone = newtz;
     $('span.time').each(function () {
       $(this).html(format_time(this.start_time, newtz, this.format) + '-' +
         format_time(this.end_time, newtz, 1));
     });
     update_tooltips_all();
     update_clock();
    }

   // Highlight ongoing based on the current time
   function highlight_ongoing() {
     $("div").remove("#now");
     var agenda_rows=$('[slot_start]')
     agenda_rows.removeClass("ongoing");
     agenda_rows = agenda_rows.filter(function() {
         return moment().isBetween(this.slot_start, this.slot_end);
       });
     agenda_rows.addClass("ongoing");
     agenda_rows.first().children("th, td").
       prepend($('<div id="now" class="anchor-target"></div>'));
   }

   // Update tooltips
   function update_tooltips() {
     var tooltips=$('.timetooltiptext');
     tooltips.filter(function() {
       return moment().isBetween(this.ustart_time, this.uend_time);
     }).each(function () {
       $(this).html(format_tooltip_table(this.start_time, this.end_time));
     });
   }

   // Update all tooltips
   function update_tooltips_all() {
     var tooltips=$('.timetooltiptext');
     tooltips.each(function () {
       $(this).html(format_tooltip_table(this.start_time, this.end_time));
     });
   }
   
   // Update clock
   function update_clock() {
     $('#current-time').html(format_time(moment(), current_timezone, 0));
   }

   // This should be if debug, that does not work.
   {% if True %}

   $.urlParam = function(name) {
     var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
     if (results == null) {
       return null;
     } else {
       return results[1] || 0;
     }
   }

   speedup = +$.urlParam('speedup');
   if (speedup < 1) {
     speedup = 1;
   }
   start_time = moment().utc();
   if ($.urlParam('date')) {
     offset_time = moment.tz(decodeURIComponent($.urlParam('date')), "UTC");
   } else {
     offset_time = start_time;
   }
   if (speedup > 1 || offset_time != start_time) {
     moment.now = function () {
       return (+new Date() - start_time) * speedup + offset_time;
     }
   }
   {% else %}
   speedup = 1;
   {% endif %}

   // Get meeting and local times, initialize timezone system
   meeting_timezone = "{{timezone}}";
   local_timezone = moment.tz.guess();
   current_timezone = 'UTC';
   {% if "-utc" in request.path %}
   timezone_init('UTC');
   {% else %}
   timezone_init(meeting_timezone);
   {% endif %}

   function init_timers() {
     update_clock();
     highlight_ongoing();
     setInterval(function() { update_clock(); }, 60000 / speedup);
     setInterval(function() { highlight_ongoing(); }, 60000 / speedup);
     setInterval(function() { update_tooltips(); }, 60000 / speedup);
     setInterval(function() { update_tooltips_all(); }, 3600000 / speedup);
  }
  init_timers();
  </script>
{% endblock %}
