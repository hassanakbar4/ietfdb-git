{% extends "ietf.html" %}

{% load crispy_forms_tags %}

{% block title %}
Change the document shepherd for {{ doc.name }}-{{ doc.rev }}
{% endblock %}

{% block pagehead %}
<link rel="stylesheet" href="/facelift/css/tokenfield-typeahead.min.css"></link>
<link rel="stylesheet" href="/facelift/css/bootstrap-tokenfield.min.css"></link>
{% endblock %}

{% block content %}
<h1>Change the document shepherd for {{ doc.name }}-{{ doc.rev }}</h1>
<form class="tokenized-form" role="form" method="post">
	{% csrf_token %}
	{{ form|crispy }}
	<div class="buttonlist">
		<button type="submit" class="btn btn-primary">Submit</button>
		<a class="btn btn-default pull-right" href="{% url "doc_view" name=doc.name %}">Back</a>
	</div>
</form>
{% endblock %}

{% block js %}
<script type="text/javascript" src="/facelift/js/lib/underscore-min.js"></script>
<script type="text/javascript" src="/facelift/js/lib/typeahead.js"></script>
<script type="text/javascript" src="/facelift/js/lib/bootstrap-tokenfield.min.js"></script>
{% endblock %}

{% block scripts %}
function to_disp(t) {
	return _.unescape(t).replace(/[<>]/g, function (m) {
		return {
			'<': '(',
			'>': ')'
		}[m];
	});
}

function from_disp(t) {
	var s = t.split(",");
	for (var i = 0, length = s.length; i < length; i++) {
		s[i] = s[i].replace(/.*\((.*)\).*/g, "$1");
	}
	return s.join(", ");
}

$(".tokenized-form").submit(function (e) {
	$(this).find(".tokenized-field").each(function () {
		$(this).val(from_disp($(this).val()));
	});
});

$(".tokenized-field").each(function () {
	var raw = $(this).val();
	if (raw) {
		raw = $.parseJSON(raw);
		var pre = "";
		for (var i in raw) {
			pre += to_disp(raw[i].name) + ", ";
		}
		$(this).val(pre);
	}

	var bh = new Bloodhound({
		datumTokenizer: function (d) {
			return Bloodhound.tokenizers.nonword(d.name);
		},
  		queryTokenizer: Bloodhound.tokenizers.nonword,
  		limit: 20,
		remote: {
			url: $(this).data("ajax-url") + "?q=%QUERY",
			filter: function (data) {
				for (var i in data) {
					data[i]["value"] = to_disp(data[i]["name"]);
				}
				return data;
			}
		}
	});
	bh.initialize();
	$(this).tokenfield({
		typeahead: [{
			highlight: true,
			minLength: 3,
			hint: true,
		}, {
			source: bh.ttAdapter(),
		}],
		createTokensOnBlur: true,
		beautify: true,
		delimiter: [',', ';']
	});
});
{% endblock %}
